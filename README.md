# é¹¦é¹‰èƒŒè¯µ FastAPI - Docker å®¹å™¨åŒ–ç‰ˆ

ğŸ¯ **AIé©±åŠ¨çš„ä¸­å°å­¦èƒŒè¯µä½œä¸šè‡ªåŠ¨åŒ–å¹³å°** - æ”¯æŒDockerå®¹å™¨åŒ–ä¸€é”®éƒ¨ç½²

ä¸€ä¸ªåŸºäºFastAPIçš„éŸ³è§†é¢‘æ–‡ä»¶å¤„ç†å’ŒAIèƒŒè¯µåˆ†ææœåŠ¡ï¼Œé›†æˆFFmpegåª’ä½“å¤„ç†ã€Cloudflare AIè¯­éŸ³è¯†åˆ«ã€GLM-4æ™ºèƒ½åˆ†æç­‰åŠŸèƒ½ã€‚

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

- ğŸµ **éŸ³è§†é¢‘æ–‡ä»¶ä¸Šä¼ å¤„ç†** (æœ€å¤§100MB)
- ğŸ¬ **æ™ºèƒ½å‹ç¼©è½¬æ¢** (FFmpeg, MP3/MP4)  
- ğŸ—£ï¸ **AIè¯­éŸ³è¯†åˆ«** (Cloudflare Whisper)
- ğŸ§  **æ™ºèƒ½èƒŒè¯µåˆ†æ** (GLM-4)
- â˜ï¸ **äº‘å­˜å‚¨é›†æˆ** (Supabase Storage)
- ğŸ³ **å®¹å™¨åŒ–éƒ¨ç½²** (Docker + Nginx)
- ğŸ“Š **å¥åº·æ£€æŸ¥ç›‘æ§** (è‡ªåŠ¨é‡å¯)

## ğŸ”„ æŠ€æœ¯æ ˆ

- **åç«¯**: FastAPI + Python 3.12
- **åª’ä½“å¤„ç†**: FFmpeg
- **AIæœåŠ¡**: Cloudflare Workers AI + GLM-4
- **å­˜å‚¨**: Supabase Storage  
- **å®¹å™¨åŒ–**: Docker + Docker Compose
- **åå‘ä»£ç†**: Nginx
- **åŒ…ç®¡ç†**: uv

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# 1. å…‹éš†é¡¹ç›®
git clone https://github.com/your-username/polly-memo-fastapi.git
cd polly-memo-fastapi

# 2. è¿è¡Œè‡ªåŠ¨éƒ¨ç½²è„šæœ¬
./scripts/deploy.sh

# 3. æŒ‰æç¤ºç¼–è¾‘ .env æ–‡ä»¶ï¼Œç„¶åé‡æ–°è¿è¡Œ
./scripts/deploy.sh
```

### æ‰‹åŠ¨Dockeréƒ¨ç½²

```bash
# 1. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env  # ç¼–è¾‘å¹¶å¡«å…¥çœŸå®APIå¯†é’¥

# 2. æ„å»ºå¹¶å¯åŠ¨æœåŠ¡
docker compose up -d

# 3. æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker compose ps
```

## ğŸ“‹ ç¯å¢ƒè¦æ±‚

- **Docker** 20.10+
- **Docker Compose** v2.0+
- **æœåŠ¡å™¨é…ç½®**: 2æ ¸2Gå†…å­˜ï¼ˆæœ€å°ï¼‰ï¼Œ4æ ¸4Gå†…å­˜ï¼ˆæ¨èï¼‰

## ğŸ”§ é…ç½®è¯´æ˜

åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®ä»¥ä¸‹å¿…è¦å‚æ•°ï¼š

```env
# Supabase é…ç½®
SUPABASE_KEY=your_supabase_anon_key_here

# Cloudflare Workers AI é…ç½®  
CLOUDFLARE_ACCOUNT_ID=your_cloudflare_account_id
CLOUDFLARE_API_TOKEN=your_cloudflare_api_token

# GLM-4 æ¨¡å‹é…ç½®
GLM4_API_KEY=your_glm4_api_key_here
```

## ğŸŒ è®¿é—®æœåŠ¡

éƒ¨ç½²æˆåŠŸåï¼Œæ‚¨å¯ä»¥è®¿é—®ï¼š

- **ä¸»æœåŠ¡**: http://localhost/
- **APIæ–‡æ¡£**: http://localhost/docs  
- **å¥åº·æ£€æŸ¥**: http://localhost/health
- **ç›‘æ§é¢æ¿**: http://localhost:3000 (ç”Ÿäº§ç¯å¢ƒ)

## ğŸ› ï¸ ç®¡ç†å‘½ä»¤

```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
./scripts/deploy.sh status

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
./scripts/deploy.sh logs

# é‡å¯æœåŠ¡
./scripts/deploy.sh restart

# åœæ­¢æœåŠ¡
./scripts/deploy.sh stop

# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
./scripts/deploy.sh prod

# åˆ›å»ºå¤‡ä»½
./scripts/deploy.sh backup
```

## API ä½¿ç”¨è¯´æ˜

### ä¸Šä¼ å’Œå¤„ç†åª’ä½“æ–‡ä»¶

**ç«¯ç‚¹**: `POST /api/v1/media/upload`

**åŠŸèƒ½**: ä¸Šä¼ éŸ³è§†é¢‘æ–‡ä»¶ï¼Œè‡ªåŠ¨è¿›è¡Œå‹ç¼©å’Œæ ¼å¼è½¬æ¢

**è¯·æ±‚**:
- `file`: è¦ä¸Šä¼ çš„éŸ³é¢‘æˆ–è§†é¢‘æ–‡ä»¶ï¼ˆmultipart/form-dataï¼‰

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "file_url": "https://your-project.supabase.co/storage/v1/object/public/media-files/audio/uuid.mp3",
  "file_type": "audio",
  "original_size": 15728640,
  "processed_size": 8388608,
  "compression_ratio": 0.53,
  "message": "æ–‡ä»¶å¤„ç†å¹¶ä¸Šä¼ æˆåŠŸ"
}
```

### å¥åº·æ£€æŸ¥

**ç«¯ç‚¹**: `GET /api/v1/media/health`

**åŠŸèƒ½**: æ£€æŸ¥åª’ä½“å¤„ç†æœåŠ¡çŠ¶æ€

**å“åº”ç¤ºä¾‹**:
```json
{
  "status": "healthy",
  "service": "media-processing",
  "temp_dir": "/tmp/media_processing",
  "max_file_size_mb": 100,
  "target_file_size_mb": 10
}
```

## å¤„ç†æµç¨‹

1. **æ–‡ä»¶éªŒè¯**: æ£€æŸ¥æ–‡ä»¶ç±»å‹å’Œå¤§å°
2. **ä¸´æ—¶å­˜å‚¨**: å°†ä¸Šä¼ çš„æ–‡ä»¶ä¿å­˜åˆ°ä¸´æ—¶ç›®å½•
3. **ç±»å‹æ£€æµ‹**: è‡ªåŠ¨è¯†åˆ«éŸ³é¢‘æˆ–è§†é¢‘æ–‡ä»¶
4. **å¤§å°æ£€æŸ¥**: åˆ¤æ–­æ˜¯å¦éœ€è¦å‹ç¼©
5. **æ ¼å¼è½¬æ¢**: éŸ³é¢‘è½¬MP3ï¼Œè§†é¢‘è½¬MP4
6. **æ™ºèƒ½å‹ç¼©**: è¶…è¿‡10MBæ—¶è‡ªåŠ¨å‹ç¼©
7. **äº‘å­˜å‚¨ä¸Šä¼ **: ä¸Šä¼ åˆ°Supabase Storage
8. **ä¸´æ—¶æ–‡ä»¶æ¸…ç†**: åˆ é™¤å¤„ç†è¿‡ç¨‹ä¸­çš„ä¸´æ—¶æ–‡ä»¶

## æ”¯æŒçš„æ–‡ä»¶æ ¼å¼

### éŸ³é¢‘æ ¼å¼
- MP3, WAV, FLAC, M4A, AAC, OGG
- è¾“å‡ºæ ¼å¼ï¼šMP3 (128kbps)

### è§†é¢‘æ ¼å¼  
- MP4, AVI, MOV, MKV, WMV, FLV
- è¾“å‡ºæ ¼å¼ï¼šMP4 (H.264/AAC)

## é…ç½®è¯´æ˜

| é…ç½®é¡¹ | è¯´æ˜ | é»˜è®¤å€¼ |
|--------|------|--------|
| `MAX_FILE_SIZE` | æœ€å¤§ä¸Šä¼ æ–‡ä»¶å¤§å° | 100MB |
| `TARGET_FILE_SIZE` | ç›®æ ‡å‹ç¼©å¤§å° | 10MB |
| `TEMP_DIR` | ä¸´æ—¶æ–‡ä»¶ç›®å½• | `/tmp/media_processing` |
| `SUPABASE_BUCKET_NAME` | Storage bucketåç§° | `media-files` |

## é”™è¯¯å¤„ç†

APIä¼šè¿”å›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼š

- `400`: æ–‡ä»¶ç±»å‹ä¸æ”¯æŒæˆ–å‚æ•°é”™è¯¯
- `413`: æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶
- `500`: æ–‡ä»¶å¤„ç†æˆ–ä¸Šä¼ å¤±è´¥
- `503`: æœåŠ¡ä¸å¯ç”¨

## å¼€å‘æŒ‡å—

### é¡¹ç›®ç»“æ„

```
polly-memo-fastapi/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/v1/endpoints/    # APIç«¯ç‚¹
â”‚   â”œâ”€â”€ core/               # æ ¸å¿ƒé…ç½®
â”‚   â”œâ”€â”€ schemas/            # Pydanticæ¨¡å¼
â”‚   â””â”€â”€ services/           # ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€ main.py                 # åº”ç”¨å…¥å£
â”œâ”€â”€ pyproject.toml         # é¡¹ç›®é…ç½®
â””â”€â”€ .env.example           # ç¯å¢ƒå˜é‡ç¤ºä¾‹
```

### æ·»åŠ æ–°åŠŸèƒ½

1. åœ¨ `app/services/` ä¸­æ·»åŠ ä¸šåŠ¡é€»è¾‘
2. åœ¨ `app/schemas/` ä¸­å®šä¹‰æ•°æ®æ¨¡å¼
3. åœ¨ `app/api/v1/endpoints/` ä¸­æ·»åŠ APIç«¯ç‚¹
4. æ›´æ–°è·¯ç”±é…ç½®

## ğŸ—ï¸ é¡¹ç›®æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Nginxåå‘ä»£ç†  â”‚â”€â”€â”€â†’â”‚  FastAPIåº”ç”¨å®¹å™¨  â”‚â”€â”€â”€â†’â”‚  å¤–éƒ¨æœåŠ¡ä¾èµ–    â”‚
â”‚   - è´Ÿè½½å‡è¡¡     â”‚    â”‚  - Python 3.12   â”‚    â”‚  - Supabase     â”‚
â”‚   - SSLç»ˆç«¯     â”‚    â”‚  - FFmpegå¤„ç†     â”‚    â”‚  - Cloudflare   â”‚
â”‚   - é™æ€æ–‡ä»¶     â”‚    â”‚  - å¥åº·æ£€æŸ¥       â”‚    â”‚  - GLM-4 API    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“– è¯¦ç»†æ–‡æ¡£

- [å®Œæ•´éƒ¨ç½²æŒ‡å—](DOCKER_DEPLOYMENT.md) - è¯¦ç»†çš„Dockeréƒ¨ç½²å’Œè¿ç»´æŒ‡å—
- [APIæ–‡æ¡£](http://localhost/docs) - å¯åŠ¨åè®¿é—®äº¤äº’å¼APIæ–‡æ¡£

## è®¸å¯è¯

MIT License

---

ğŸ“ **æŠ€æœ¯æ”¯æŒ**: æŸ¥çœ‹ [éƒ¨ç½²æŒ‡å—](DOCKER_DEPLOYMENT.md) æˆ–æäº¤ [Issue](https://github.com/your-username/polly-memo-fastapi/issues)

## è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestï¼